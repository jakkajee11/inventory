// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT BOUNDARY
// =============================================================================

/// Company represents the tenant boundary for multi-tenant SaaS
model Company {
  id        String   @id @default(uuid())
  name      String
  taxId     String?  @map("tax_id")
  address   String?
  phone     String?
  email     String?
  currency  String   @default("THB")
  timezone  String   @default("Asia/Bangkok")
  logo      String?
  settings  Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  warehouses         Warehouse[]
  categories         Category[]
  units              Unit[]
  products           Product[]
  stockMovements     StockMovement[]
  goodsReceipts      GoodsReceipt[]
  goodsIssues        GoodsIssue[]
  stockAdjustments   StockAdjustment[]
  notifications      Notification[]
  auditLogs          AuditLog[]

  @@map("companies")
}

// =============================================================================
// USER MANAGEMENT
// =============================================================================

model User {
  id            String   @id @default(uuid())
  email         String
  passwordHash  String   @map("password_hash")
  name          String
  phone         String?
  avatar        String?
  roleId        String   @map("role_id")
  companyId     String   @map("company_id")
  warehouseId   String?  @map("warehouse_id")
  isActive      Boolean  @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  role             Role              @relation(fields: [roleId], references: [id])
  company          Company           @relation(fields: [companyId], references: [id])
  warehouse        Warehouse?        @relation(fields: [warehouseId], references: [id])
  stockMovements   StockMovement[]
  goodsReceipts    GoodsReceipt[]
  goodsIssues      GoodsIssue[]
  stockAdjustments StockAdjustment[]
  notifications    Notification[]
  auditLogs        AuditLog[]

  @@unique([companyId, email])
  @@index([companyId])
  @@index([companyId, email])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   // Admin, Manager, Staff, Viewer
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id        String   @id @default(uuid())
  roleId    String   @map("role_id")
  module    String   // e.g., "products", "inventory", "goods_receipt", "goods_issue", "users", "reports"
  action    String   // CREATE, READ, UPDATE, DELETE, APPROVE
  isGranted Boolean  @default(true) @map("is_granted")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, module, action])
  @@map("permissions")
}

// =============================================================================
// PRODUCT MANAGEMENT
// =============================================================================

model Category {
  id          String    @id @default(uuid())
  companyId   String    @map("company_id")
  name        String
  description String?
  parentId    String?   @map("parent_id")
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  company   Company    @relation(fields: [companyId], references: [id])
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([companyId, parentId])
  @@map("categories")
}

model Unit {
  id               String    @id @default(uuid())
  companyId        String    @map("company_id")
  name             String
  abbreviation     String
  baseUnitId       String?   @map("base_unit_id")
  conversionFactor Decimal?  @map("conversion_factor") @db.Decimal(10, 4)
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  // Relations
  company     Company @relation(fields: [companyId], references: [id])
  baseUnit    Unit?   @relation("UnitHierarchy", fields: [baseUnitId], references: [id], onDelete: SetNull)
  derivedUnits Unit[]  @relation("UnitHierarchy")
  products    Product[]

  @@unique([companyId, abbreviation])
  @@index([companyId])
  @@map("units")
}

model Product {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  sku             String
  barcode         String?
  name            String
  description     String?
  categoryId      String?   @map("category_id")
  unitId          String    @map("unit_id")
  costPrice       Decimal   @map("cost_price") @db.Decimal(15, 2)
  sellingPrice    Decimal   @map("selling_price") @db.Decimal(15, 2)
  minStock        Int       @default(0) @map("min_stock")
  maxStock        Int?      @map("max_stock")
  currentStock    Int       @default(0) @map("current_stock")
  averageCost     Decimal   @default(0) @map("average_cost") @db.Decimal(15, 2)
  images          Json?
  isActive        Boolean   @default(true) @map("is_active")
  version         Int       @default(0) // Optimistic locking
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  company            Company           @relation(fields: [companyId], references: [id])
  category           Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  unit               Unit              @relation(fields: [unitId], references: [id])
  stockMovements     StockMovement[]
  goodsReceiptItems  GoodsReceiptItem[]
  goodsIssueItems    GoodsIssueItem[]
  adjustmentItems    StockAdjustmentItem[]

  @@unique([companyId, sku])
  @@index([companyId])
  @@index([companyId, sku])
  @@index([companyId, barcode])
  @@index([companyId, categoryId])
  @@map("products")
}

// =============================================================================
// INVENTORY TRACKING
// =============================================================================

model StockMovement {
  id             String   @id @default(uuid())
  companyId      String   @map("company_id")
  productId      String   @map("product_id")
  warehouseId    String   @map("warehouse_id")
  type           String   // IN, OUT, ADJUST
  quantity       Int      // Positive for IN, Negative for OUT
  unitCost       Decimal  @map("unit_cost") @db.Decimal(15, 2)
  balanceAfter   Int      @map("balance_after")
  averageCostAfter Decimal @map("average_cost_after") @db.Decimal(15, 2)
  referenceType  String   @map("reference_type") // GOODS_RECEIPT, GOODS_ISSUE, STOCK_ADJUSTMENT
  referenceId    String   @map("reference_id")
  referenceNo    String   @map("reference_no")
  notes          String?
  userId         String   @map("user_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  company   Company  @relation(fields: [companyId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([companyId, productId])
  @@index([companyId, createdAt])
  @@index([companyId, productId, createdAt])
  @@map("stock_movements")
}

// =============================================================================
// WAREHOUSE
// =============================================================================

model Warehouse {
  id          String    @id @default(uuid())
  companyId   String    @map("company_id")
  code        String
  name        String
  address     String?
  phone       String?
  isDefault   Boolean   @default(false) @map("is_default")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  company        Company          @relation(fields: [companyId], references: [id])
  users          User[]
  stockMovements StockMovement[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("warehouses")
}

// =============================================================================
// GOODS RECEIPT (IN)
// =============================================================================

model GoodsReceipt {
  id             String    @id @default(uuid())
  companyId      String    @map("company_id")
  receiptNo      String    @map("receipt_no")
  supplierName   String    @map("supplier_name")
  supplierPhone  String?   @map("supplier_phone")
  supplierEmail  String?   @map("supplier_email")
  receiptDate    DateTime  @map("receipt_date")
  status         String    @default("DRAFT") // DRAFT, PENDING, APPROVED, CANCELLED
  totalAmount    Decimal   @map("total_amount") @db.Decimal(15, 2)
  notes          String?
  attachments    Json?
  createdById    String    @map("created_by_id")
  approvedById   String?   @map("approved_by_id")
  approvedAt     DateTime? @map("approved_at")
  cancelledById  String?   @map("cancelled_by_id")
  cancelledAt    DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  // Relations
  company   Company            @relation(fields: [companyId], references: [id])
  createdBy User               @relation("GoodsReceiptCreatedBy", fields: [createdById], references: [id])
  approvedBy User?             @relation("GoodsReceiptApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  cancelledBy User?            @relation("GoodsReceiptCancelledBy", fields: [cancelledById], references: [id], onDelete: SetNull)
  items     GoodsReceiptItem[]

  @@unique([companyId, receiptNo])
  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, receiptDate])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id             String   @id @default(uuid())
  receiptId      String   @map("receipt_id")
  productId      String   @map("product_id")
  quantity       Int
  unitCost       Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost      Decimal  @map("total_cost") @db.Decimal(15, 2)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  receipt  GoodsReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  product  Product      @relation(fields: [productId], references: [id])

  @@index([receiptId])
  @@index([productId])
  @@map("goods_receipt_items")
}

// =============================================================================
// GOODS ISSUE (OUT)
// =============================================================================

model GoodsIssue {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  issueNo           String    @map("issue_no")
  issueType         String    @map("issue_type") // SALE, DAMAGE, INTERNAL, OTHER
  recipientName     String?   @map("recipient_name")
  recipientPhone    String?   @map("recipient_phone")
  recipientEmail    String?   @map("recipient_email")
  issueDate         DateTime  @map("issue_date")
  status            String    @default("DRAFT") // DRAFT, PENDING, APPROVED, CANCELLED
  totalAmount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  notes             String?
  attachments       Json?
  createdById       String    @map("created_by_id")
  approvedById      String?   @map("approved_by_id")
  approvedAt        DateTime? @map("approved_at")
  cancelledById     String?   @map("cancelled_by_id")
  cancelledAt       DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  // Relations
  company   Company           @relation(fields: [companyId], references: [id])
  createdBy User              @relation("GoodsIssueCreatedBy", fields: [createdById], references: [id])
  approvedBy User?            @relation("GoodsIssueApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  cancelledBy User?           @relation("GoodsIssueCancelledBy", fields: [cancelledById], references: [id], onDelete: SetNull)
  items     GoodsIssueItem[]

  @@unique([companyId, issueNo])
  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, issueDate])
  @@map("goods_issues")
}

model GoodsIssueItem {
  id             String   @id @default(uuid())
  issueId        String   @map("issue_id")
  productId      String   @map("product_id")
  quantity       Int
  unitCost       Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost      Decimal  @map("total_cost") @db.Decimal(15, 2)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  issue  GoodsIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  product Product    @relation(fields: [productId], references: [id])

  @@index([issueId])
  @@index([productId])
  @@map("goods_issue_items")
}

// =============================================================================
// STOCK ADJUSTMENT
// =============================================================================

model StockAdjustment {
  id                String    @id @default(uuid())
  companyId         String    @map("company_id")
  adjustmentNo      String    @map("adjustment_no")
  adjustmentType    String    @map("adjustment_type") // COUNT, DAMAGE, RETURN, OTHER
  adjustmentDate    DateTime  @map("adjustment_date")
  status            String    @default("DRAFT") // DRAFT, PENDING, APPROVED, CANCELLED
  totalAmount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  notes             String?
  attachments       Json?
  createdById       String    @map("created_by_id")
  approvedById      String?   @map("approved_by_id")
  approvedAt        DateTime? @map("approved_at")
  cancelledById     String?   @map("cancelled_by_id")
  cancelledAt       DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  // Relations
  company   Company                @relation(fields: [companyId], references: [id])
  createdBy User                   @relation("StockAdjustmentCreatedBy", fields: [createdById], references: [id])
  approvedBy User?                 @relation("StockAdjustmentApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  cancelledBy User?                @relation("StockAdjustmentCancelledBy", fields: [cancelledById], references: [id], onDelete: SetNull)
  items     StockAdjustmentItem[]

  @@unique([companyId, adjustmentNo])
  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, adjustmentDate])
  @@map("stock_adjustments")
}

model StockAdjustmentItem {
  id             String   @id @default(uuid())
  adjustmentId   String   @map("adjustment_id")
  productId      String   @map("product_id")
  quantityBefore Int      @map("quantity_before")
  quantityAfter  Int      @map("quantity_after")
  quantityDiff   Int      @map("quantity_diff") // quantityAfter - quantityBefore
  unitCost       Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost      Decimal  @map("total_cost") @db.Decimal(15, 2)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  adjustment StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id])

  @@index([adjustmentId])
  @@index([productId])
  @@map("stock_adjustment_items")
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  userId          String    @map("user_id")
  type            String    // LOW_STOCK, ZERO_STOCK, PENDING_APPROVAL, SYSTEM
  title           String
  message         String
  data            Json?
  isRead          Boolean   @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")
  deliveryChannel String    @default("IN_APP") @map("delivery_channel") // IN_APP, EMAIL
  sentAt          DateTime? @map("sent_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([userId, isRead])
  @@index([companyId, createdAt])
  @@map("notifications")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  companyId  String   @map("company_id")
  userId     String   @map("user_id")
  action     String   // CREATE, UPDATE, DELETE, APPROVE, CANCEL, LOGIN, LOGOUT
  entityType String   @map("entity_type") // Product, GoodsReceipt, GoodsIssue, etc.
  entityId   String   @map("entity_id")
  oldValue   Json?
  newValue   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([companyId, entityType])
  @@index([companyId, entityId])
  @@index([companyId, createdAt])
  @@map("audit_logs")
}
