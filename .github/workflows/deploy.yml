name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main, 001-inventory-management]
    jobs:
      - test
      - build

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/001-inventory-management'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: ./

      - name: Deploy to staging
        run: |
          echo "Deploying to staging..."
          # Add your deployment commands here
          # For example: kubectl apply -f k8s/ -n staging

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    needs: [deploy-staging]
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: ./

      - name: Deploy to production
        run: |
          echo "Deploying to production..."
          # Add your deployment commands here
          # For example: kubectl apply -f k8s/ -n production

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  version-bump:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: ./

      - name: Tag version
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Get version from tag
            const version = process.env.GITHUB_REF.replace('refs/tags/', '');

            // Update version in package.json files
            const packageJsons = [
              'apps/api/package.json',
              'apps/web/package.json',
              'package.json'
            ];

            packageJsons.forEach(pkgPath => {
              const fullPath = path.join(process.cwd(), pkgPath);
              if (fs.existsSync(fullPath)) {
                const pkg = JSON.parse(fs.readFileSync(fullPath, 'utf8'));
                pkg.version = version;
                fs.writeFileSync(fullPath, JSON.stringify(pkg, null, 2));
                console.log(`Updated ${pkgPath} to version ${version}`);
              }
            });

      - name: Commit and push version bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Version bump to ${{ github.ref_name }}"
          file_pattern: "package.json"

      - name: Build and publish Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/inventory-api:${{ github.ref_name }}
            ${{ secrets.DOCKER_USERNAME }}/inventory-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and publish web Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/inventory-web:${{ github.ref_name }}
            ${{ secrets.DOCKER_USERNAME }}/inventory-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max